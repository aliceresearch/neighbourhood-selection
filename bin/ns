#!/usr/bin/env ruby

require 'neighbourhood-selection'

# You must require commander (actually highline) after rinruby, otherwise we get
# weird piping errors in R.
require 'commander/import'

# Specify version number here
VERSION = '0.0.1'

# For commander
program :version, VERSION
program :description, "A simulation tool for the relevant neighbourhood selection problem."

# Default to the intro / help page
default_command :help

command :run do |c|
  c.syntax = "ns run <experiment_name> [experiment2_name] [experiment3_name] ...

    Run the experiment(s) with the configuration experiment_name."

  c.description = "Run one or more experiments. The experiments must be defined in the experiment configuration file."

  c.option '--config <filename>', String, 'Use the specified experiment configuration file instead of the default.'
  c.option '--noexperiments', "Don't actually run the experiments, just generate the graphs."
  c.option '--nographs', "Don't generate any graphs after running the experiments."
  c.option '--nographtitles', "Don't add titles to the generated graphs. Has no effect if --nographs is also given."
  c.option '--nostats', "Don't generate summary statistics at the end of the simulation."

  c.action do |args, options|

    unless args[0]
      warn "You must specify at least one experiment name."
      exit
    end

    # Run each experiment in turn.
    args.each do |experiment_name|
      create_and_run_experiment experiment_name, options
    end

  end

end


# Actually create an experiment object, and run it.
def create_and_run_experiment experiment_name, options

    # If we've been passed a --config <filename>, then use that instead of
    # 'config/experiment.yml'
    #
    # Create the simulation itself:
    if options.config
      experiment = Experiment.new experiment_name, options.file
    else
      experiment = Experiment.new experiment_name
    end

    # Run the experiment using the config given.
    experiment.run !options.noexperiments, !options.nographs, !options.nographtitles, !options.nostats
end
